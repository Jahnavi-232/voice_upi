<!DOCTYPE html>
<html>
<head>
    <title>Voice Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<h2>Voice + Face Payment</h2>

<!-- Voice Section -->
<input id="voiceText" placeholder="Say: Pay 500 to daddy" style="width:300px;">
<br><br>
<button onclick="startVoice()">ðŸŽ¤ Speak</button>

<br><br><hr><br>

<!-- Camera Section -->
<video id="video" width="300" autoplay></video>
<canvas id="canvas" style="display:none;"></canvas>

<br><br>
<button onclick="verifyFace()">Verify Face & Pay</button>

<script>

let streamStarted = false;

// Start Camera Automatically
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
    document.getElementById('video').srcObject = stream;
    streamStarted = true;
})
.catch(error => {
    alert("Camera access denied!");
});

// ---------------- VOICE ----------------

function startVoice() {

    if (!('webkitSpeechRecognition' in window)) {
        alert("Speech Recognition not supported in this browser");
        return;
    }

    var recognition = new webkitSpeechRecognition();
    recognition.lang = "en-IN";

    recognition.onresult = function(event) {
        document.getElementById("voiceText").value =
            event.results[0][0].transcript;
    };

    recognition.onerror = function() {
        alert("Voice recognition failed");
    };

    recognition.start();
}

// ---------------- FACE VERIFY ----------------

function verifyFace(){

    if(!streamStarted){
        alert("Camera not ready!");
        return;
    }

    var canvas = document.getElementById('canvas');
    var video = document.getElementById('video');

    canvas.width = 300;
    canvas.height = 300;

    canvas.getContext('2d').drawImage(video, 0, 0, 300, 300);

    var image = canvas.toDataURL("image/jpeg", 0.6);

    fetch("/verify_face", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "image=" + encodeURIComponent(image)
    })
    .then(res => res.json())
    .then(data => {

        if(data.status === "matched"){
            alert("Face Verified Successfully!");
            processPayment();
        }
        else if(data.status === "no_user"){
            alert("No Registered User Found!");
        }
        else{
            alert("Face Not Matched!");
        }
    });
}

// ---------------- PAYMENT ----------------

function processPayment() {

    var text = document.getElementById("voiceText").value;

    if(!text){
        alert("Please speak payment command first.");
        return;
    }

    var amountMatch = text.match(/\d+/);

    if(!amountMatch){
        alert("Amount not detected in voice command.");
        return;
    }

    var amount = amountMatch[0];

    fetch("/create_order", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "amount=" + amount
    })
    .then(res => res.json())
    .then(order => {

        var options = {
            "key": "{{ key_id }}",
            "amount": order.amount,
            "currency": "INR",
            "order_id": order.id,
            "name": "Voice UPI App",
            "description": "Secure Voice Payment",
            "handler": function (response){
                alert("Payment Successful!");
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        var rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(error => {
        alert("Payment creation failed!");
    });
}

</script>

</body>
</html>